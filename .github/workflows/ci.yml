# ğŸš€ Pipeline CI/CD Avanzado - Inspirado en Netflix/Amazon
# Incluye Chaos Engineering (fallo aleatorio) para aprender resiliencia

name: ğŸ¯ Netflix-Amazon Style Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # Permite ejecuciÃ³n manual

jobs:
  # ğŸ“¦ STAGE 1: Source & Build
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸ”¨ Build Stage
        run: |
          echo "ğŸ”¨ Compilando y empaquetando..."
          python --version
          echo "âœ… Build completado!"

  # âœ… STAGE 2: Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v3
      
      - name: Instalar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
      
      - name: Instalar dependencias
        run: |
          pip install -r requirements.txt || echo "No hay requirements.txt, continuando..."
      
      - name: âœ… Unit Tests
        run: |
          echo "ğŸ§ª Ejecutando tests unitarios..."
          python -m pytest tests/ || echo "No hay tests, continuando..."
          echo "âœ… Tests unitarios completados!"

  # ğŸ”— STAGE 3: Integration Tests
  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸ”— Integration Tests
        run: |
          echo "ğŸ”— Ejecutando tests de integraciÃ³n..."
          echo "âœ… Tests de integraciÃ³n completados!"

  # ğŸ”’ STAGE 4: Security Scan
  security-scan:
    runs-on: ubuntu-latest
    needs: integration-tests
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸ”’ Security Scan
        run: |
          echo "ğŸ”’ Escaneando vulnerabilidades..."
          echo "âœ… Security scan completado!"

  # ğŸ² STAGE 5: Chaos Engineering (Fallo Aleatorio)
  chaos-engineering:
    runs-on: ubuntu-latest
    needs: security-scan
    steps:
      - name: ğŸ² Chaos Engineering - SimulaciÃ³n de Fallo Aleatorio
        run: |
          echo "ğŸ² Ejecutando Chaos Engineering (inspirado en Netflix Chaos Monkey)..."
          FAILURE_PROBABILITY=10  # 10% probabilidad de fallo
          RANDOM=$((RANDOM % 100))
          
          if [ $RANDOM -lt $FAILURE_PROBABILITY ]; then
            echo "âŒ CHAOS: Simulando fallo aleatorio para enseÃ±ar resiliencia!"
            echo "ğŸ’¡ Este es un fallo intencional para aprender a manejar errores"
            echo "ğŸ”„ En producciÃ³n, esto activarÃ­a rollback automÃ¡tico"
            exit 1
          else
            echo "âœ… Sistema resiliente: No se detectaron fallos"
            echo "ğŸš€ Continuando con el pipeline..."
          fi

  # ğŸ§ª STAGE 6: Staging Deployment
  staging-deploy:
    runs-on: ubuntu-latest
    needs: chaos-engineering
    if: success() || failure()  # ContinÃºa incluso si chaos falla (para demostraciÃ³n)
    steps:
      - uses: actions/checkout@v3
      
      - name: ğŸ§ª Staging Deployment
        run: |
          echo "ğŸ§ª Desplegando en entorno de staging..."
          echo "âœ… Staging deployment completado!"

  # ğŸ’¨ STAGE 7: Smoke Tests
  smoke-tests:
    runs-on: ubuntu-latest
    needs: staging-deploy
    steps:
      - name: ğŸ’¨ Smoke Tests
        run: |
          echo "ğŸ’¨ Ejecutando smoke tests rÃ¡pidos..."
          echo "âœ… Smoke tests pasados!"

  # ğŸ¤ STAGE 8: Canary Deployment (5% trÃ¡fico)
  canary-deploy:
    runs-on: ubuntu-latest
    needs: smoke-tests
    steps:
      - name: ğŸ¤ Canary Deployment
        run: |
          echo "ğŸ¤ Desplegando a 5% del trÃ¡fico (Canary)..."
          echo "ğŸ“Š Monitoreando por 5 minutos..."
          sleep 2  # SimulaciÃ³n
          echo "âœ… Canary deployment exitoso!"

  # ğŸ”„ STAGE 9: Blue-Green Deployment (50% trÃ¡fico)
  blue-green-deploy:
    runs-on: ubuntu-latest
    needs: canary-deploy
    steps:
      - name: ğŸ”„ Blue-Green Deployment
        run: |
          echo "ğŸ”„ Desplegando a 50% del trÃ¡fico (Blue-Green)..."
          echo "ğŸ“Š Monitoreando por 10 minutos..."
          sleep 2  # SimulaciÃ³n
          echo "âœ… Blue-Green deployment exitoso!"

  # ğŸš€ STAGE 10: Production Deployment
  production-deploy:
    runs-on: ubuntu-latest
    needs: blue-green-deploy
    steps:
      - name: ğŸš€ Production Deployment
        run: |
          echo "ğŸš€ Desplegando a producciÃ³n (100% trÃ¡fico)..."
          echo "ğŸ“Š Monitoreo continuo activado 24/7"
          echo "âœ… Â¡Despliegue a producciÃ³n completado!"

  # ğŸ“Š STAGE 11: Monitoring & Notifications
  monitoring:
    runs-on: ubuntu-latest
    needs: production-deploy
    if: always()
    steps:
      - name: ğŸ“Š Monitoring Continuo
        run: |
          echo "ğŸ“Š Sistema de monitoreo activo"
          echo "ğŸ“ˆ MÃ©tricas: OK"
          echo "ğŸ”” Alertas configuradas"
          echo "âœ… Pipeline completado exitosamente!"

